/**
 * amis-core v2.9.0
 * Copyright 2018-2023 fex
 */

import { __awaiter, __generator, __assign } from 'tslib';
import { normalizeApiResponseData } from '../utils/api.js';
import { ServerError } from '../utils/errors.js';
import { isEmpty } from '../utils/helper.js';
import { registerAction } from './Action.js';
import { createObject } from '../utils/object.js';

/**
 * 发送请求动作
 *
 * @export
 * @class AjaxAction
 * @implements {Action}
 */
var AjaxAction = /** @class */ (function () {
    function AjaxAction(fetcherType) {
        if (fetcherType === void 0) { fetcherType = 'ajax'; }
        this.fetcherType = fetcherType;
    }
    AjaxAction.prototype.run = function (action, renderer, event) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0;
        return __awaiter(this, void 0, void 0, function () {
            var env, result, responseData, msg, e_1, result;
            var _1;
            return __generator(this, function (_2) {
                switch (_2.label) {
                    case 0:
                        if (!((_a = renderer.props.env) === null || _a === void 0 ? void 0 : _a.fetcher)) {
                            throw new Error('env.fetcher is required!');
                        }
                        if (this.fetcherType === 'download' && action.actionType === 'download') {
                            if ((_b = action.args) === null || _b === void 0 ? void 0 : _b.api) {
                                action.args.api.responseType = 'blob';
                            }
                        }
                        env = event.context.env;
                        _2.label = 1;
                    case 1:
                        _2.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, env.fetcher((_c = action.args) === null || _c === void 0 ? void 0 : _c.api, (_d = action.data) !== null && _d !== void 0 ? _d : {}, (_f = (_e = action.args) === null || _e === void 0 ? void 0 : _e.options) !== null && _f !== void 0 ? _f : {})];
                    case 2:
                        result = _2.sent();
                        responseData = !isEmpty(result.data) || result.ok
                            ? normalizeApiResponseData(result.data)
                            : null;
                        // 记录请求返回的数据
                        event.setData(createObject(event.data, __assign(__assign({}, responseData), (_1 = { responseData: responseData }, _1[action.outputVar || 'responseResult'] = __assign(__assign({}, responseData), { responseData: responseData, responseStatus: result.status, responseMsg: result.msg }), _1))));
                        if (!((_h = (_g = action.args) === null || _g === void 0 ? void 0 : _g.options) === null || _h === void 0 ? void 0 : _h.silent)) {
                            if (!result.ok) {
                                throw new ServerError((_q = (_m = (_l = (_k = (_j = action.args) === null || _j === void 0 ? void 0 : _j.api) === null || _k === void 0 ? void 0 : _k.messages) === null || _l === void 0 ? void 0 : _l.failed) !== null && _m !== void 0 ? _m : (_p = (_o = action.args) === null || _o === void 0 ? void 0 : _o.messages) === null || _p === void 0 ? void 0 : _p.failed) !== null && _q !== void 0 ? _q : result.msg, result);
                            }
                            else {
                                msg = (_y = (_x = (_u = (_t = (_s = (_r = action.args) === null || _r === void 0 ? void 0 : _r.api) === null || _s === void 0 ? void 0 : _s.messages) === null || _t === void 0 ? void 0 : _t.success) !== null && _u !== void 0 ? _u : (_w = (_v = action.args) === null || _v === void 0 ? void 0 : _v.messages) === null || _w === void 0 ? void 0 : _w.success) !== null && _x !== void 0 ? _x : result.msg) !== null && _y !== void 0 ? _y : result.defaultMsg;
                                msg &&
                                    env.notify('success', msg, result.msgTimeout !== undefined
                                        ? {
                                            closeButton: true,
                                            timeout: result.msgTimeout
                                        }
                                        : undefined);
                            }
                        }
                        return [2 /*return*/, result.data];
                    case 3:
                        e_1 = _2.sent();
                        if (!((_0 = (_z = action.args) === null || _z === void 0 ? void 0 : _z.options) === null || _0 === void 0 ? void 0 : _0.silent)) {
                            if (e_1.type === 'ServerError') {
                                result = e_1.response;
                                env.notify('error', e_1.message, result.msgTimeout !== undefined
                                    ? {
                                        closeButton: true,
                                        timeout: result.msgTimeout
                                    }
                                    : undefined);
                            }
                            else {
                                env.notify('error', e_1.message);
                            }
                        }
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    return AjaxAction;
}());
registerAction('ajax', new AjaxAction());
registerAction('download', new AjaxAction('download'));

export { AjaxAction };
