/**
 * amis-core v2.9.0
 * Copyright 2018-2023 fex
 */

import { __values, __assign } from 'tslib';
import { isPureVariable } from './isPureVariable.js';
import { resolveVariableAndFilter } from './resolveVariableAndFilter.js';
import { tokenize } from './tokenize.js';
import isPlainObject from 'lodash/isPlainObject';
import { createObject, setVariable, deleteVariable } from './object.js';

function resolveMapping(value, data, defaultFilter, ignoreIfNotMatch) {
    if (defaultFilter === void 0) { defaultFilter = '| raw'; }
    if (ignoreIfNotMatch === void 0) { ignoreIfNotMatch = false; }
    var result = typeof value === 'string' && isPureVariable(value)
        ? resolveVariableAndFilter(value, data, defaultFilter, function () { return ''; })
        : typeof value === 'string' && ~value.indexOf('$')
            ? tokenize(value, data, defaultFilter)
            : value;
    if (ignoreIfNotMatch && (result == null || result === '')) {
        return value;
    }
    return result;
}
/**
 * 遍历对象，对每个字符串 key 进行数据映射
 * @param value 要映射的对象
 * @param data 数据上下文
 */
function resolveMappingObject(value, data) {
    var e_1, _a;
    try {
        for (var _b = __values(Object.keys(value)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var key = _c.value;
            if (typeof value[key] === 'string') {
                value[key] = resolveMapping(value[key], data);
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_1) throw e_1.error; }
    }
    return value;
}
function dataMapping(to, from, ignoreFunction, convertKeyToPath, ignoreIfNotMatch) {
    if (from === void 0) { from = {}; }
    if (ignoreFunction === void 0) { ignoreFunction = false; }
    if (ignoreIfNotMatch === void 0) { ignoreIfNotMatch = false; }
    if (Array.isArray(to)) {
        return to.map(function (item) {
            return dataMapping(item, from, ignoreFunction, convertKeyToPath, ignoreIfNotMatch);
        });
    }
    else if (typeof to === 'string') {
        return resolveMapping(to, from, undefined, ignoreIfNotMatch);
    }
    else if (!isPlainObject(to)) {
        return to;
    }
    var ret = {};
    var keys = Object.keys(to);
    if (keys.length === 1 && keys[0][0] === '$' && isPlainObject(to[keys[0]])) {
        // from[keys[0].substring(1)] &&
        // Array.isArray(from[keys[0].substring(1)])
        // 支持只取数组中的部分值这个需求
        // 如:
        // data: {
        //   items: {
        //     '$rows': {
        //        id: '$id',
        //        forum_id: '$forum_id'
        //      }
        //   }
        // }
        var left = resolveMapping(keys[0], from, '| raw');
        if (!Array.isArray(left) && ignoreIfNotMatch) {
            ret[keys[0]] = to[keys[0]];
        }
        else {
            var arr = Array.isArray(left) ? left : [];
            var mapping_1 = to[keys[0]];
            ret = arr.map(function (raw) {
                return dataMapping(mapping_1, createObject(from, __assign({ item: raw }, raw)), ignoreFunction, convertKeyToPath, ignoreIfNotMatch);
            });
        }
    }
    else {
        Object.keys(to).forEach(function (key) {
            var value = to[key];
            var keys;
            if (typeof ignoreFunction === 'function' && ignoreFunction(key, value)) {
                // 如果被ignore，不做数据映射处理。
                setVariable(ret, key, value, convertKeyToPath);
            }
            else if (key === '&' && value === '$$') {
                ret = __assign(__assign({}, ret), from);
            }
            else if (key === '&') {
                var v = isPlainObject(value) &&
                    (keys = Object.keys(value)) &&
                    keys.length === 1 &&
                    from[keys[0].substring(1)] &&
                    Array.isArray(from[keys[0].substring(1)])
                    ? from[keys[0].substring(1)].map(function (raw) {
                        return dataMapping(value[keys[0]], createObject(from, raw), ignoreFunction, convertKeyToPath, ignoreIfNotMatch);
                    })
                    : resolveMapping(value, from, undefined, ignoreIfNotMatch);
                if (Array.isArray(v) || typeof v === 'string') {
                    ret = v;
                }
                else if (typeof v === 'function') {
                    ret = __assign(__assign({}, ret), v(from));
                }
                else {
                    ret = __assign(__assign({}, ret), v);
                }
            }
            else if (value === '$$') {
                setVariable(ret, key, from, convertKeyToPath);
            }
            else if (value && value[0] === '$') {
                var v = resolveMapping(value, from, undefined, ignoreIfNotMatch);
                setVariable(ret, key, v, convertKeyToPath);
                if (v === '__undefined') {
                    deleteVariable(ret, key);
                }
            }
            else if (isPlainObject(value) || Array.isArray(value)) {
                setVariable(ret, key, dataMapping(value, from, ignoreFunction, convertKeyToPath, ignoreIfNotMatch), convertKeyToPath);
            }
            else if (typeof value == 'string' && ~value.indexOf('$')) {
                setVariable(ret, key, resolveMapping(value, from, undefined, ignoreIfNotMatch), convertKeyToPath);
            }
            else if (typeof value === 'function' && ignoreFunction !== true) {
                setVariable(ret, key, value(from), convertKeyToPath);
            }
            else {
                setVariable(ret, key, value, convertKeyToPath);
                if (value === '__undefined') {
                    deleteVariable(ret, key);
                }
            }
        });
    }
    return ret;
}

export { dataMapping, resolveMapping, resolveMappingObject };
